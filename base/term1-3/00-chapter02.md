# ã„ã‚ã„ã‚ã¨ãƒ‡ãƒ¼ã‚¿ã‚’èª¿æ•´ã™ã‚‹

![9d2c38e6fe48e61528f6b2d34370768f](https://i.gyazo.com/9d2c38e6fe48e61528f6b2d34370768f.png)

## ã“ã®ç« ã§å­¦ã¶ã“ã¨

ã„ã‚ã„ã‚ã¨ãƒ‡ãƒ¼ã‚¿ã‚’èª¿æ•´ã™ã‚‹

- ã‚·ãƒ³ãƒ—ãƒ«ã«å‹•ã‹ã—ã¦ã¿ã‚‹
- å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚ã„ã•ã¤æ–‡ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã—ã¦ã¿ã‚‹ï¼ˆResponseData.titleï¼‰
- è‡ªåˆ†ã®åå‰ã‚’é€ã£ã¦ã„ã¦ã‚µãƒ¼ãƒãƒ¼ã§ã‚ã„ã•ã¤æ–‡ã‚’ä½œã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRequestData.nameï¼‰
- å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã«åæ˜ ã—ã¦ã¿ã‚‹ï¼ˆResponseData.add_pointï¼‰
- å®Ÿã¯ term1-2 chapter02 ã®ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ã§ã¾ã¨ã‚ãŸã“ã¨ã‚’ç¢ºèª
- ã‚²ãƒ¼ãƒ ãƒã‚¤ãƒ³ãƒˆã®è¨˜éŒ²ã‚’ç¢ºèªï¼ˆRequestData.pointï¼‰
- ã‚²ãƒ¼ãƒ ãƒã‚¤ãƒ³ãƒˆã®è¨˜éŒ²ãŒæˆåŠŸã™ã‚‹ã¨è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆãŒè¿”ã£ã¦ãã‚‹ã®ã§ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã—ã¦ã¿ã‚‹ï¼ˆResponseData.recordPointï¼‰
- åˆæœŸèµ·å‹•æ™‚ã® API ã§è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- å®Ÿã¯ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹é–“ã€è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆã¯ä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- åˆæœŸèµ·å‹•æ™‚ã«å—ã‘å–ã£ãŸè¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆã‚’åæ˜ ã™ã‚Œã°å†é–‹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
- å†èµ·å‹•ã—ã¦è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚‚ç¢ºèª

## Codespace ã®èµ·å‹•

![0a3a35f3418068b7713ddaa729f2c660](https://i.gyazo.com/0a3a35f3418068b7713ddaa729f2c660.png)

GitHub ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸçŠ¶æ…‹ã§ https://github.com/codespaces ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

![34de49185c6b28fb938519084d5b36fe](https://i.gyazo.com/34de49185c6b28fb938519084d5b36fe.png)

Codespaces ã®ãƒšãƒ¼ã‚¸ã§ã™ã€‚ã•ãã»ã©ä½¿ã£ã¦ã„ãŸ Codespace ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•ã—ã¾ã™ã€‚

## ã‚µãƒ¼ãƒã®èµ·å‹•

![0a3a35f3418068b7713ddaa729f2c660](https://i.gyazo.com/0a3a35f3418068b7713ddaa729f2c660.png)

- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ `node term1-3-chapter02.js` ã‚’ã‚µãƒ¼ãƒèµ·å‹•
- ãƒãƒ¼ãƒˆã‚¿ãƒ–ã§ä»Šå›ã®ã‚µãƒ¼ãƒèµ·å‹•ã‚’å…¬é–‹
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ä»Šå›ã®ã‚µãƒ¼ãƒãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™

ã“ã¡ã‚‰ã®æ‰‹é †ã‚’é€²ã‚ã¾ã™ã€‚

âœ…ãƒã‚¤ãƒ³ãƒˆ
- ä»Šå›ã¯ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ 2 ã¤ã®ä»•çµ„ã¿ã‚’ä½œã£ã¦ã„ã¾ã™
- `/api/post/result` ã¨ã„ã†ãƒ‘ã‚¹ã§ã¯ã€ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆå—ä¿¡ã—ã¦è¨˜éŒ²ã€‚ã•ã‚‰ã«ä»Šè¨˜éŒ²ã—ãŸã‚‚ã®ã‚’è¿”ç­”ã€‚
- `/api/post/init` ã¨ã„ã†ãƒ‘ã‚¹ã§ã¯ã€åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã„ã‚ã„ã‚ãªæƒ…å ±ã‚’ã‚‚ã‚‰ã„ã¾ã™ã€‚
- `recordPoint` ã¨ã„ã†ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²ã™ã‚‹å¤‰æ•°ã‚‚ã‚ã‚Šã¾ã™ã€‚
  - ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã®å¤‰æ•°ãªã®ã§ãƒ¡ãƒ¢ãƒªã§å‹•ã„ã¦ã„ã¾ã™
  - ã“ã‚Œã¯ã‚µãƒ¼ãƒã‚’å†èµ·å‹•ã™ã‚‹ã¨åˆæœŸåŒ–ã•ã‚Œã¾ã™ãŒèµ·å‹•ã—ã¦ã„ã‚‹é–“ã¯è¨˜éŒ²ã—ã¦ãã‚Œã¦ã„ã¾ã™
- å—ä¿¡ã—ãŸç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²ã«ã‚‚æ³¨ç›®
- ã‚ã„ã•ã¤æ–‡ã®å€¤ã®æµã‚Œã«ã‚‚æ³¨ç›®

## ä»Šå›ã® Unity ã‚·ãƒ¼ãƒ³ã‚’èµ·å‹•

![6049726527f3133083e8ca07d1e6261c](https://i.gyazo.com/6049726527f3133083e8ca07d1e6261c.png)

Project ã‚¿ãƒ–ã‹ã‚‰ Assets > Scenes ã‚’é¸æŠã—ã¾ã™ã€‚Scene-Term1-3-Chapter02 ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•ã—ã¾ã—ã‚‡ã†ã€‚

ä»Šæ—¥ã¯ã€ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€é€ã‚‹å€¤ã‚„å—ã‘å–ã‚‹å€¤ã‚’ Unity ã«ä½¿ã£ã¦ã„ãã¾ã™ã€‚

âœ…ãƒã‚¤ãƒ³ãƒˆ
- ClickPart ãŒ Term1-2 Chapter02 ã«è¿‘ã„ä»•çµ„ã¿ã§ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒã‚¤ãƒ³ãƒˆãŒåŠ ç®—ã•ã‚ŒãŸã‚Šã€åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã„ã‚ã„ã‚ãªæƒ…å ±ã‚’ã‚µãƒ¼ãƒã® `/api/post/init` ã‹ã‚‰å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚
- SendButton ãŒ Term1-3 Chapter01 ã¨ã»ã¼åŒã˜ä»•çµ„ã¿ã§ ClickPart ã®å¾—ãŸãƒã‚¤ãƒ³ãƒˆã‚’ã‚µãƒ¼ãƒã® `/api/post/result` ã«é€ã£ã¦ã„ã¾ã™ã€‚

## Term1_3_Chapter02_ClickPart.cs å¤‰æ›´

`Assets/Scripts/Term1_3_Chapter02_ClickPart.cs` ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ãã¾ã™ã€‚

```csharp
using UnityEngine;
using UnityEngine.EventSystems;

using System.Collections;       // IEnumerator ã®ãŸã‚ã®å‚ç…§
using UnityEngine.Networking;   // UnityWebRequest ã®ãŸã‚ã®å‚ç…§
using System.Text;              // Encoding ã®ãŸã‚ã®å‚ç…§
using System;                   // Serializable ã®ãŸã‚ã®å‚ç…§

public class Term1_3_Chapter02_ClickPart : MonoBehaviour, IPointerClickHandler
{
    // å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class ResponseData
    {
        // result ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string result;
    }

    // é€ä¿¡ã™ã‚‹ Unity ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ãƒ‡ãƒ¼ã‚¿åŒ–ã™ã‚‹ RequestData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class RequestData
    {   
        // è‡ªåˆ†ã®åå‰
        // name ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string name;
    }

    // ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ URL
    // ã‚µãƒ¼ãƒãƒ¼ URL + /api/post/init
    string urlGitHub = "ã“ã“ã«ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥ã‚Œã‚‹";

    // ãƒã‚¤ãƒ³ãƒˆåŠ ç®—è¨­å®š
    int addPoint = 1;

    // è“„ç©ãƒã‚¤ãƒ³ãƒˆ
    public int currentPoint = 0;

    void Start()
    {
        // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€

        // HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’éåŒæœŸå‡¦ç†ã‚’å¾…ã¤ãŸã‚ã‚³ãƒ«ãƒ¼ãƒãƒ³ã¨ã—ã¦å‘¼ã³å‡ºã™
        StartCoroutine("RequestInit");

        // è“„ç©ãƒã‚¤ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆ
        currentPoint = 0;
    }

    public void OnPointerClick(PointerEventData eventData)
    {
        // ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        // Debug.Log($"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ {this.name} ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚ˆï¼");

        // ãƒã‚¤ãƒ³ãƒˆåŠ ç®—
        currentPoint += addPoint;

        // ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ 
        string infomation = currentPoint + "pt";
        GameObject.Find("CurrentPointMessage").GetComponent<TextMesh>().text = infomation;
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹æœ¬ä½“
    IEnumerator RequestInit()
    {
        // HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹(POST ãƒ¡ã‚½ãƒƒãƒ‰) UnityWebRequest ã‚’å‘¼ã³å‡ºã—
        // ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å…ˆã¯å¤‰æ•° urlGitHub ã§è¨­å®š
        UnityWebRequest request = new UnityWebRequest(urlGitHub, "POST");

        // ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å™¨ã¨ã—ã¦å‘¼ã³å‡ºã™
        RequestData requestData = new RequestData();
        // ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        // requestData.name = "ã¾ã„ã­ãƒ¼ã‚€"; // è‡ªåˆ†ã®åå‰

        // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ JsonUtility.ToJson ã§ JSON æ–‡å­—åˆ—ã‚’ä½œæˆ
        // pointRequestData ã®æ§‹é€ ã«åŸºã¥ã„ã¦å¤‰æ›ã—ã¦ãã‚Œã‚‹
        string strJSON = JsonUtility.ToJson(requestData);
        Debug.Log($"strJSON : {strJSON}");
        // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ Encoding.UTF8.GetBytes ã§ byte ãƒ‡ãƒ¼ã‚¿åŒ–
        byte[] bodyRaw = Encoding.UTF8.GetBytes(strJSON);

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆUnityâ†’ã‚µãƒ¼ãƒï¼‰ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆ
        request.uploadHandler = new UploadHandlerRaw(bodyRaw);
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚µãƒ¼ãƒâ†’Unityï¼‰ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆ
        request.downloadHandler = new DownloadHandlerBuffer();

        // JSON ã§é€ã‚‹ã¨ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã§å®£è¨€ã™ã‚‹
        request.SetRequestHeader("Content-Type", "application/json");

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
        Debug.Log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹");
        yield return request.SendWebRequest();

        // çµæœã«ã‚ˆã£ã¦åˆ†å²
        switch (request.result)
        {
            case UnityWebRequest.Result.InProgress:
                Debug.Log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­");
                break;

            case UnityWebRequest.Result.Success:
                Debug.Log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ");

                // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                Debug.Log($"responseData: {request.downloadHandler.text}");

                // ResponseData ã‚¯ãƒ©ã‚¹ã§ Unity ã§æ‰±ãˆã‚‹ãƒ‡ãƒ¼ã‚¿åŒ–
                ResponseData responseData = JsonUtility.FromJson<ResponseData>(request.downloadHandler.text);

                // MessageText ã«çµæœãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦
                GameObject.Find("StatusMessage").GetComponent<TextMesh>().text = responseData.result;

                break;
        }


    }

    // Update is called once per frame
    void Update()
    {

    }
}
```

ä»¥ä¸‹ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```csharp
// ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ URL
// ã‚µãƒ¼ãƒãƒ¼ URL + /api/post/init
string urlGitHub = "ã“ã“ã«ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥ã‚Œã‚‹";
```

ã“ã¡ã‚‰ã‚’ã‚µãƒ¼ãƒãƒ¼ URL ã« `/api/post/init` ã¨ã„ã†ãƒ‘ã‚¹ã‚’åŠ ãˆã¦å¤‰æ›´ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

è§£èª¬ã—ã¾ã™ã€‚

ä»Šå›ã¯ Term1-2 Chapter02 ã«è¿‘ã„ä»•çµ„ã¿ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```csharp
// å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
[Serializable]
public class ResponseData
{
    // result ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
    public string result;
}
```

å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„ã—ã¦ã€ã€Œã²ã¨ã¾ãšã€result å€¤ã ã‘ Unity ã®å€¤ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã€Œã²ã¨ã¾ãšã€ã¨ã—ãŸã®ã¯ã€

```js
{
    "result":"OK",
    "title":"ã“ã‚“ã«ã¡ã¯ï¼ã‚ˆã†ã“ãï¼",  // ã‚ã„ã•ã¤æ–‡
    "add_point":1,  // åŠ ç®—ãƒã‚¤ãƒ³ãƒˆ
    "recordPoint":0 // è¨˜éŒ²ã—ã¦ã„ã‚‹ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ
};
```

ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å—ã‘å–ã‚Œã‚‹ãŸã‚ã€ã‚ã¨ã§æ‹¡å¼µã™ã‚‹ãŸã‚ã§ã™ã€‚JsonUtility ã¯ã‚¯ãƒ©ã‚¹ã§æº–å‚™ã—ãŸä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ã‚‚ã€ç„¡è¦–ã•ã‚Œã‚‹ã®ã§ã€ã“ã®ã‚ˆã†ãªã“ã¨ãŒã§ãã¾ã™ã€‚

```csharp
// é€ä¿¡ã™ã‚‹ Unity ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ãƒ‡ãƒ¼ã‚¿åŒ–ã™ã‚‹ RequestData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
[Serializable]
public class RequestData
{   
    // è‡ªåˆ†ã®åå‰
    // name ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
    public string name;
}
```

é€ä¿¡ã™ã‚‹ Unity ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ãƒ‡ãƒ¼ã‚¿åŒ–ã™ã‚‹ RequestData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã§ã¯ã€ã‚µãƒ¼ãƒã«è‡ªåˆ†ã®åå‰ã‚’ name ã¨ã„ã†å€¤ã§é€ã‚Œã‚‹ã‚ˆã†æº–å‚™ã—ã¦ã„ã¾ã™ã€‚

```csharp
// ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å™¨ã¨ã—ã¦å‘¼ã³å‡ºã™
RequestData requestData = new RequestData();
// ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
// requestData.name = "ã¾ã„ã­ãƒ¼ã‚€"; // è‡ªåˆ†ã®åå‰
```

æœ€åˆã«å‹•ã‹ã™ã¨ãã¯ name æœªè¨­å®šãªã®ã§ `{"name":""}` ã¨ç©ºã®æ–‡å­—åˆ—ã§å‹•ä½œã—ã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ `requestData.name = "ã¾ã„ã­ãƒ¼ã‚€";` ã®éƒ¨åˆ†ãŒå‹•ä½œã™ã‚‹ã®ã§ã€ã‚µãƒ¼ãƒãŒå‡ºæ¥ã‚‹ title ã®å€¤ãŒ `ã“ã‚“ã«ã¡ã¯ï¼ã‚ˆã†ã“ãï¼` ã‹ã‚‰ `ã“ã‚“ã«ã¡ã¯ï¼ã¾ã„ã­ãƒ¼ã‚€ã•ã‚“ã€ã‚ˆã†ã“ãï¼` ã¨å‹•ä½œã—ã¾ã™ã€‚

ã‚ã¨ã¯ã€POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

## Term1_3_Chapter02_SendButton.cs å¤‰æ›´

`Assets/Scripts/Term1_3_Chapter02_SendButton.cs` ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ãã¾ã™ã€‚

```csharp
using UnityEngine;
using UnityEngine.EventSystems;

using System.Collections;       // IEnumerator ã®ãŸã‚ã®å‚ç…§
using UnityEngine.Networking;   // UnityWebRequest ã®ãŸã‚ã®å‚ç…§
using System;                   // Serializable ã®ãŸã‚ã®å‚ç…§
using System.Text;              // Encoding ã®ãŸã‚ã®å‚ç…§

public class Term1_3_Chapter02_SendButton : MonoBehaviour, IPointerClickHandler
{
    // Term1_3_Chapter01_CubeEvent ã¨ã»ã¼åŒã˜

    // å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResultResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class ResultResponseData
    {
        // result ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string result;
    }

    // é€ä¿¡ã™ã‚‹ Unity ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ãƒ‡ãƒ¼ã‚¿åŒ–ã™ã‚‹ PointRequestData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class PointRequestData
    {
        // point ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ int å‹ã§å¤‰æ›
        public int point;
    }

    // ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ URL
    // ã‚µãƒ¼ãƒãƒ¼URL + /api/post/result ã§ã‚¢ã‚¯ã‚»ã‚¹
    string urlGitHub = "ã“ã“ã«ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥ã‚Œã‚‹";

    public void OnPointerClick(PointerEventData eventData)
    {
        // ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        // Debug.Log($"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ {this.name} ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚ˆï¼");

        // HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’éåŒæœŸå‡¦ç†ã‚’å¾…ã¤ãŸã‚ã‚³ãƒ«ãƒ¼ãƒãƒ³ã¨ã—ã¦å‘¼ã³å‡ºã™
        StartCoroutine("PostPointData");
    }

    // POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹æœ¬ä½“
    IEnumerator PostPointData()
    {
        // HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹(POST ãƒ¡ã‚½ãƒƒãƒ‰) UnityWebRequest ã‚’å‘¼ã³å‡ºã—
        // ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å…ˆã¯å¤‰æ•° urlGitHub ã§è¨­å®š
        UnityWebRequest request = new UnityWebRequest(urlGitHub, "POST");


        // PointRequestData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å™¨ã¨ã—ã¦å‘¼ã³å‡ºã™
        PointRequestData pointRequestData = new PointRequestData();
        // ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        pointRequestData.point = 1000; // ãƒ€ãƒŸãƒ¼ã§ 1000 pt ã®ã‚²ãƒ¼ãƒ çµæœã‚’é€ã‚‹
        pointRequestData.point = GameObject.Find("ClickPart").GetComponent<Term1_3_Chapter02_ClickPart>().currentPoint;

        // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ JsonUtility.ToJson ã§ JSON æ–‡å­—åˆ—ã‚’ä½œæˆ
        // pointRequestData ã®æ§‹é€ ã«åŸºã¥ã„ã¦å¤‰æ›ã—ã¦ãã‚Œã‚‹
        string strJSON = JsonUtility.ToJson(pointRequestData);
        Debug.Log($"strJSON : {strJSON}");
        // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ Encoding.UTF8.GetBytes ã§ byte ãƒ‡ãƒ¼ã‚¿åŒ–
        byte[] bodyRaw = Encoding.UTF8.GetBytes(strJSON);

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆUnityâ†’ã‚µãƒ¼ãƒï¼‰ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆ
        request.uploadHandler = new UploadHandlerRaw(bodyRaw);
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚µãƒ¼ãƒâ†’Unityï¼‰ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆ
        request.downloadHandler = new DownloadHandlerBuffer();

        // JSON ã§é€ã‚‹ã¨ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã§å®£è¨€ã™ã‚‹
        request.SetRequestHeader("Content-Type", "application/json");

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
        yield return request.SendWebRequest();

        // çµæœã«ã‚ˆã£ã¦åˆ†å²
        switch (request.result)
        {
            case UnityWebRequest.Result.InProgress:
                Debug.Log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­");
                break;

            case UnityWebRequest.Result.Success:
                Debug.Log("ãƒªã‚¯ã‚¨ã‚¹ãƒˆæˆåŠŸ");

                // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                Debug.Log($"responseData: {request.downloadHandler.text}");

                // ResultResponseData ã‚¯ãƒ©ã‚¹ã§ Unity ã§æ‰±ãˆã‚‹ãƒ‡ãƒ¼ã‚¿åŒ–
                ResultResponseData resultResponse = JsonUtility.FromJson<ResultResponseData>(request.downloadHandler.text);

                // MessageText ã«çµæœãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦
                GameObject.Find("StatusMessage").GetComponent<TextMesh>().text = resultResponse.result;

                break;
        }

    }
}
```

ä»¥ä¸‹ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```csharp
// ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ URL
// ã‚µãƒ¼ãƒãƒ¼URL + /api/post/result ã§ã‚¢ã‚¯ã‚»ã‚¹
string urlGitHub = "ã“ã“ã«ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥ã‚Œã‚‹";
```

ã“ã¡ã‚‰ã‚’ã‚µãƒ¼ãƒãƒ¼ URL ã« `/api/post/result` ã¨ã„ã†ãƒ‘ã‚¹ã‚’åŠ ãˆã¦å¤‰æ›´ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

è§£èª¬ã—ã¾ã™ã€‚

ä»Šå›ã¯Term1_3_Chapter01_CubeEvent ã¨ã»ã¼åŒã˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚SendButton ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’ ClickPart ã‹ã‚‰å–å¾—ã—ã¦ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã—ã¾ã™ã€‚

```csharp
// ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
pointRequestData.point = GameObject.Find("ClickPart").GetComponent<Term1_3_Chapter02_ClickPart>().currentPoint;
```

ã“ã®ã‚ˆã†ã«å€¤ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚ã‚ã¨ã¯åŒã˜ã§ã™ã€‚

## ã‚·ãƒ³ãƒ—ãƒ«ã«å‹•ã‹ã—ã¦ã¿ã‚‹

ã¾ãšã¯ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã¤ãªãè¨­å®šãŒã§ããŸã®ã§å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![ad833d19086696f4841ff7d11828b4fb](https://i.gyazo.com/ad833d19086696f4841ff7d11828b4fb.png)

Play ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![7d4dad403a48608db49b89293e8d58ec](https://i.gyazo.com/7d4dad403a48608db49b89293e8d58ec.png)

ClickPart ã®ä¸Šã® StatusMessage ã«ã‚µãƒ¼ãƒã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã—ã¦ã‹ã‚‰ result å€¤ã® OK ã‚’è¡¨ç¤ºã§ãã¦ã„ã‚Œã°ã€ã†ã¾ãã¤ãªãŒã£ã¦ã„ã¾ã™ã€‚

![d687f574cde14e7f191c84470ce760a1](https://i.gyazo.com/d687f574cde14e7f191c84470ce760a1.png)

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚ã‚„ã‚Šå–ã‚Šã®æ§˜å­ãŒç¢ºèªã§ãã¾ã™ã€‚

```
/api/post/init å—ä¿¡
{ name: '' }
```

Codespace å´ã§ã‚‚ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å­—å—ä¿¡ã§ããŸã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![2d930e83bef28594da9fd7c29ea512f5](https://i.gyazo.com/2d930e83bef28594da9fd7c29ea512f5.png)

ç¶šã„ã¦ã€ClickPart ã‚’ä½•åº¦ã‹ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚ã¨ã«ã€çµæœé€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

```
/api/post/result å—ä¿¡
{ point: 8 }
8 pt è¨˜éŒ²
```

Codespace å´ã§ã‚‚ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å­—å—ä¿¡ã§ããŸã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![99365fca16458a0ad1e75e9a731efaba](https://i.gyazo.com/99365fca16458a0ad1e75e9a731efaba.png)

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚ã‚„ã‚Šå–ã‚Šã®æ§˜å­ãŒç¢ºèªã§ãã¾ã™ã€‚ã¾ãŸã“ã®å€¤ã¯ã€ã‚µãƒ¼ãƒã§å—ä¿¡ã—ãŸæ™‚ç‚¹ã§ã‚µãƒ¼ãƒã« recordPoint ã¨ã„ã†å€¤ã§è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹é–“ã€è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚

![c8e76c52116732bee393f9e0128beb3c](https://i.gyazo.com/c8e76c52116732bee393f9e0128beb3c.png)

ã¾ãŸã€ã“ã¡ã‚‰ã¯åˆæœŸèµ·å‹•æ™‚ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ã‚‚ã€è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆãŒè¿”ã£ã¦ãã¦ã„ã¾ã™ã€‚ï¼ˆå†åº¦ã¤ãªã„ã§ã¿ãŸæ§˜å­ï¼‰

## å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚ã„ã•ã¤æ–‡ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã—ã¦ã¿ã‚‹ï¼ˆResponseData.titleï¼‰

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

Term1_3_Chapter02_ClickPart ã®å¯¾å¿œã§ã™ã€‚

<details>
<summary>ğŸ“‹ç­”ãˆï¼ˆå‡ºé¡Œä¸­ã¯é–‹ã‹ãªã„ã§ãã ã•ã„ã­ï¼‰</summary>
<pre style="position: relative;"><code class="lang-csharp">    // å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class ResponseData
    {
        // result ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string result;
        // title ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string title;
    }
</code></pre>

ResponseData ã« title ã®èª­ã¿è¾¼ã¿ã‚’åŠ ãˆã¾ã™ã€‚

<pre style="position: relative;"><code class="lang-csharp">// StatusMessage ã«çµæœãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦
GameObject.Find("StatusMessage").GetComponent<TextMesh>().text = responseData.title;
</code></pre>

StatusMessage ã®ãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦ã‚’ responseData.title ã«å¤‰æ›´ã—ã¾ã™ã€‚

</details>

## è‡ªåˆ†ã®åå‰ã‚’é€ã£ã¦ã„ã¦ã‚µãƒ¼ãƒãƒ¼ã§ã‚ã„ã•ã¤æ–‡ã‚’ä½œã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åæ˜ ï¼ˆRequestData.nameï¼‰

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

Term1_3_Chapter02_ClickPart ã®å¯¾å¿œã§ã™ã€‚


```csharp
// åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã„ã‚ã„ã‚ãªæƒ…å ±ã‚’ã‚‚ã‚‰ã†
// /api/post/init ã¨ã„ã†ãƒ‘ã‚¹ã§ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã™
app.post('/api/post/init', (req, res) => {
  console.log('/api/post/init å—ä¿¡');
  // å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿
  console.log(req.body);
  // ã‚ã„ã•ã¤æ–‡ã®å€¤
  let title = "";
  // å—ä¿¡ã—ãŸ name å€¤ã®æœ‰ç„¡ã§æ–‡è¨€ãŒå¤‰ã‚ã‚‹
  if(req.body.name){
    title = `ã“ã‚“ã«ã¡ã¯ï¼${req.body.name}ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
  } else {
    title = "ã“ã‚“ã«ã¡ã¯ï¼ã‚ˆã†ã“ãï¼";
  }
  // é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ JavaScript ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ä½œã‚‹
  const responseData = {
    "result":"OK",
    "title":title,  // ã‚ã„ã•ã¤æ–‡
    "add_point":1,  // åŠ ç®—ãƒã‚¤ãƒ³ãƒˆ
    "recordPoint":recordPoint // è¨˜éŒ²ã—ã¦ã„ã‚‹ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ
  };
  // res.json ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ JSON å½¢å¼ã§è¿”ç­”ã—ã¾ã™
  res.json(responseData)
});
```

ã“ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒå´ã§ã¯å®Ÿã¯ name å€¤ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚ã§ã¯ name å€¤ã‚’åæ˜ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

<details>
<summary>ğŸ“‹ç­”ãˆï¼ˆå‡ºé¡Œä¸­ã¯é–‹ã‹ãªã„ã§ãã ã•ã„ã­ï¼‰</summary>

<pre style="position: relative;"><code class="lang-csharp">// ResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å™¨ã¨ã—ã¦å‘¼ã³å‡ºã™
RequestData requestData = new RequestData();
// ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
requestData.name = "ã¾ã„ã­ãƒ¼ã‚€"; // è‡ªåˆ†ã®åå‰
</code></pre>

ã“ã®ã‚ˆã†ã«æ–°ãŸãªå€¤ã‚’åŠ ãˆã¾ã™ã€‚

</details>

## å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã«åæ˜ ã—ã¦ã¿ã‚‹ï¼ˆResponseData.add_pointï¼‰

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

## ãƒã‚¤ãƒ³ãƒˆé€ä¿¡æ™‚ã«å®Ÿã¯è¨˜éŒ²ã»ã‚„ã»ã‚„ã®å€¤ãŒè¿”ã£ã¦ãã‚‹ã®ã§ã€ãã‚Œã‚’OK ã¨è¡¨ç¤ºã•ã‚Œã¦ã‚‹ StatusMessage ã«è¡¨ç¤ºã—ã¦ã¿ã‚‹ï¼ˆResultResponseData.recordPointï¼‰

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

Term1_3_Chapter02_SendButton ã®å¯¾å¿œã§ã™ã€‚

<details>
<summary>ğŸ“‹ç­”ãˆï¼ˆå‡ºé¡Œä¸­ã¯é–‹ã‹ãªã„ã§ãã ã•ã„ã­ï¼‰</summary>
<pre style="position: relative;"><code class="lang-csharp">
    // å—ä¿¡ã—ãŸ JSON ãƒ‡ãƒ¼ã‚¿ã‚’ Unity ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ ResultResponseData ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
    [Serializable]
    public class ResultResponseData
    {
        // result ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ string å‹ã§å¤‰æ›
        public string result;
        // recordPoint ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ int å‹ã§å¤‰æ›
        public int recordPoint;
    }
</code></pre>

PointRequestData ã« recordPoint ã®èª­ã¿è¾¼ã¿ã‚’åŠ ãˆã¾ã™ã€‚

<pre style="position: relative;"><code class="lang-csharp">
// MessageText ã«çµæœãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦
GameObject.Find("StatusMessage").GetComponent<TextMesh>().text = resultResponse.recordPoint.ToString();
</code></pre>

StatusMessage ã®ãƒ†ã‚­ã‚¹ãƒˆå‰²ã‚Šå½“ã¦ã‚’ responseData.recordPoint ã«æ–‡å­—åˆ—å¤‰æ›ã—ã¦å¤‰æ›´ã—ã¾ã™ã€‚

</details>

## ãƒ€ãƒŸãƒ¼ã§ãªãåŠ ç‚¹ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’ã¡ã‚ƒã‚“ã¨é€ã‚‹

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

## å†èµ·å‹•ã—ã¦è¨˜éŒ²ãƒã‚¤ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚‚ç¢ºèª

![02db792fd629a56812a205234a08ae44](https://i.gyazo.com/02db792fd629a56812a205234a08ae44.png)

## ä»Šå›ã® Codespace ã®çµ‚äº†

![0a8b4cfb807e57ea1382292a757c6899](https://i.gyazo.com/0a8b4cfb807e57ea1382292a757c6899.png)

ä»Šå›ã® Codespace çµ‚äº†ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚